workflow "Demo workflow" {
  on = "push"
  resolves = ["SNS Notification"]
}

action "Build Image" {
  uses = "actions/docker/cli@c08a5fc9e0286844156fefff2c141072048141f6"
  runs = ["/bin/sh", "-c", "docker build -t $IMAGE_URI ."]
  env = {
    IMAGE_URI = "587250238214.dkr.ecr.us-east-1.amazonaws.com/eks-poc:latest"
  }
}

action "ECR Login" {
  uses = "actions/aws/cli@51b5c9b60da75d1d3f97ff91ed2e4efc19dd5474"
  needs = ["Build Image"]
  env = {
    AWS_DEFAULT_REGION = "us-east-1"
    AWS_REGION = "$AWS_DEFAULT_REGION"
  }
  runs = ["/bin/sh", "-c", "aws ecr get-login --no-include-email | sh"]
  secrets = [
    "AWS_ACCESS_KEY_ID",
    "AWS_SECRET_ACCESS_KEY",
  ]
}


action "Push ECR" {
  uses = "actions/docker/cli@c08a5fc9e0286844156fefff2c141072048141f6"
  needs = ["ECR Login"]
  runs = ["/bin/sh", "-c",  "docker push $IMAGE_URI"]
  secrets = ["AWS_ACCESS_KEY_ID", "AWS_SECRET_ACCESS_KEY"]
  env = {
    IMAGE_URI = "587250238214.dkr.ecr.us-east-1.amazonaws.com/eks-poc:latest"
  }

}

action "Deploy to EKS" {
  uses = "actions/aws/kubectl@master"
  #   args = ["get all"]
  args = ["apply -f deployement.yaml"]
  needs = ["Push ECR"]
  secrets = [
    "KUBE_CONFIG_DATA",
    "AWS_ACCESS_KEY_ID",
    "AWS_SECRET_ACCESS_KEY",
  ]
  env = {
    AWS_DEFAULT_REGION = "us-east-1"
  }
}
